<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ML Pipeline Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.4/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Advanced ML Pipeline</h1>
            <p>End-to-End Machine Learning with Real-time Monitoring & Data Cleaning</p>
        </div>

        <div class="dashboard-grid">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Data Upload Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            üìÅ Data Management
                            <div class="status-indicator" id="upload-status"></div>
                        </div>
                    </div>

                    <div class="upload-zone" id="upload-zone">
                        <input type="file" id="file-input" class="file-input" accept=".csv" multiple>
                        <div class="upload-content">
                            <div class="upload-icon">üìä</div>
                            <h3>Drop CSV files here or click to browse</h3>
                            <p>Support for multiple files, up to 100MB each</p>
                        </div>
                    </div>

                    <div id="file-list" class="file-list"></div>

                    <div class="dataset-selection" style="margin-top: 20px;">
                        <label for="dataset-select" style="display: block; margin-bottom: 10px; font-weight: 600;">Available Datasets:</label>
                        <select id="dataset-select" class="select-field" style="width: 100%; margin-bottom: 15px;">
                            <option value="">-- Select Dataset --</option>
                            {% for dataset in datasets %}
                            <option value="{{ dataset }}">{{ dataset }}</option>
                            {% endfor %}
                        </select>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="clean-data-btn" class="btn btn-warning" disabled>
                                üßπ Clean Data
                            </button>
                            <button id="train-models-btn" class="btn btn-success" disabled>
                                üöÄ Train Models
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Real-time Activity Stream -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            üì° Live Activity Stream
                            <div class="status-indicator" id="activity-status"></div>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>

                    <div class="activity-stream" id="activity-stream">
                        <div class="activity-item">
                            <span class="activity-timestamp">--:--</span>
                            <span class="activity-message">System ready. Upload data to begin.</span>
                            <span class="activity-progress">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Data Cleaning Interface -->
                <div class="card cleaning-interface" id="cleaning-interface">
                    <div class="card-header">
                        <div class="card-title">üßπ Data Cleaning & Preprocessing</div>
                        <button id="apply-cleaning-btn" class="btn btn-primary">Apply Changes</button>
                    </div>

                    <div class="cleaning-tabs">
                        <div class="tab active" data-tab="overview">Overview</div>
                        <div class="tab" data-tab="columns">Columns</div>
                        <div class="tab" data-tab="missing">Missing Values</div>
                        <div class="tab" data-tab="encoding">Encoding</div>
                        <div class="tab" data-tab="outliers">Outliers</div>
                    </div>

                    <div class="tab-content active" id="overview-tab">
                        <div id="dataset-overview"></div>
                    </div>

                    <div class="tab-content" id="columns-tab">
                        <div class="column-list" id="columns-list"></div>
                    </div>

                    <div class="tab-content" id="missing-tab">
                        <div id="missing-values-content"></div>
                    </div>

                    <div class="tab-content" id="encoding-tab">
                        <div id="encoding-content"></div>
                    </div>

                    <div class="tab-content" id="outliers-tab">
                        <div id="outliers-content"></div>
                    </div>
                </div>

                <!-- Training Results -->
                <div class="card results-section" id="results-section">
                    <div class="card-header">
                        <div class="card-title">üèÜ Training Results</div>
                        <div>
                            <button id="export-results-btn" class="btn btn-primary">üìÅ Export Results</button>
                        </div>
                    </div>

                    <div class="metrics-grid" id="metrics-grid">
                        <!-- Metrics will be populated dynamically -->
                    </div>

                    <div class="models-comparison">
                        <h3 style="margin-bottom: 20px;">üìà Model Performance Comparison</h3>
                        <table class="models-table" id="models-table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>R¬≤ Score</th>
                                    <th>MSE</th>
                                    <th>MAE</th>
                                    <th>RMSE</th>
                                    <th>CV Score ¬±</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="models-tbody">
                            </tbody>
                        </table>
                    </div>

                    <div class="viz-grid" id="visualization-grid">
                        <!-- Visualizations will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Processing...</h3>
            <p id="loading-message">Please wait while we process your request.</p>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time updates
        const socket = io();
        let sessionId = null;
        let currentDataset = null;
        let cleaningOperations = {};

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            setupWebSocket();
        });

        function initializeEventListeners() {
            // File upload
            const fileInput = document.getElementById('file-input');
            const uploadZone = document.getElementById('upload-zone');
            const datasetSelect = document.getElementById('dataset-select');
            
            // Drag and drop functionality
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);
            uploadZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // Dataset selection
            datasetSelect.addEventListener('change', handleDatasetSelection);
            
            // Action buttons
            document.getElementById('clean-data-btn').addEventListener('click', showCleaningInterface);
            document.getElementById('train-models-btn').addEventListener('click', startTraining);
            document.getElementById('apply-cleaning-btn').addEventListener('click', applyCleaningOperations);
            
            // Cleaning tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
        }

        function setupWebSocket() {
            socket.on('session_created', (data) => {
                sessionId = data.session_id;
                addActivityLog('Session created successfully', 0);
            });

            socket.on('training_progress', (data) => {
                updateProgress(data.progress, data.message);
                addActivityLog(data.message, data.progress);
                
                if (data.data && data.progress === 100) {
                    displayTrainingResults(data.data);
                }
            });

            socket.on('training_error', (data) => {
                showAlert('Training failed: ' + data.error, 'error');
                hideLoading();
            });
        }

        // File handling functions
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function processFiles(files) {
            const csvFiles = files.filter(file => file.name.endsWith('.csv'));
            
            if (csvFiles.length === 0) {
                showAlert('Please select CSV files only.', 'warning');
                return;
            }

            csvFiles.forEach(file => uploadFile(file));
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showLoading('Uploading ' + file.name + '...');
                
                const response = await fetch('/api/upload_dataset', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('File uploaded successfully: ' + file.name, 'success');
                    addDatasetToSelect(result.file_info.filename);
                    addActivityLog(`Uploaded: ${file.name}`, 100);
                } else {
                    showAlert('Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Upload error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function populateCleaningInterface(columnInfo, datasetShape) {
            // Overview tab
            const overviewContent = document.getElementById('dataset-overview');
            overviewContent.innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${datasetShape[0]}</div>
                        <div class="metric-label">Rows</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${datasetShape[1]}</div>
                        <div class="metric-label">Columns</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${Object.values(columnInfo).reduce((sum, col) => sum + col.missing_count, 0)}</div>
                        <div class="metric-label">Missing Values</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${Object.values(columnInfo).filter(col => col.dtype === 'object').length}</div>
                        <div class="metric-label">Categorical Columns</div>
                    </div>
                </div>
            `;

            // Columns tab
            const columnsList = document.getElementById('columns-list');
            columnsList.innerHTML = Object.entries(columnInfo).map(([colName, info]) => `
                <div class="column-item">
                    <div class="column-info">
                        <div class="column-name">${colName}</div>
                        <div class="column-details">
                            Type: ${info.dtype} | Missing: ${info.missing_count} (${info.missing_percentage.toFixed(1)}%) | 
                            Unique: ${info.unique_values}
                        </div>
                    </div>
                    <div class="column-actions">
                        <input type="text" class="input-field" placeholder="Rename to..." 
                               onchange="updateRename('${colName}', this.value)">
                        <button class="btn btn-warning" onclick="markForDrop('${colName}')">Drop</button>
                    </div>
                </div>
            `).join('');

            // Missing values tab
            populateMissingValuesTab(columnInfo);
            
            // Encoding tab
            populateEncodingTab(columnInfo);
        }

        function populateMissingValuesTab(columnInfo) {
            const missingContent = document.getElementById('missing-values-content');
            const columnsWithMissing = Object.entries(columnInfo).filter(([_, info]) => info.missing_count > 0);
            
            if (columnsWithMissing.length === 0) {
                missingContent.innerHTML = '<div class="alert alert-success">‚úÖ No missing values detected!</div>';
                return;
            }

            missingContent.innerHTML = `
                <div class="alert alert-info">üìä ${columnsWithMissing.length} columns have missing values</div>
                <div class="column-list">
                    ${columnsWithMissing.map(([colName, info]) => `
                        <div class="column-item">
                            <div class="column-info">
                                <div class="column-name">${colName}</div>
                                <div class="column-details">
                                    Missing: ${info.missing_count} values (${info.missing_percentage.toFixed(1)}%)
                                </div>
                            </div>
                            <div class="column-actions">
                                <select class="select-field" onchange="updateMissingStrategy('${colName}', this.value)">
                                    <option value="">Choose strategy...</option>
                                    <option value="drop">Drop rows</option>
                                    ${info.dtype === 'object' ? '' : '<option value="mean">Fill with mean</option>'}
                                    ${info.dtype === 'object' ? '' : '<option value="median">Fill with median</option>'}
                                    <option value="mode">Fill with mode</option>
                                    <option value="forward_fill">Forward fill</option>
                                    <option value="custom_value">Custom value</option>
                                </select>
                                <input type="text" class="input-field" placeholder="Custom value" 
                                       style="display: none;" id="custom-${colName}">
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function populateEncodingTab(columnInfo) {
            const encodingContent = document.getElementById('encoding-content');
            const categoricalColumns = Object.entries(columnInfo).filter(([_, info]) => info.dtype === 'object');
            
            if (categoricalColumns.length === 0) {
                encodingContent.innerHTML = '<div class="alert alert-success">‚úÖ No categorical columns detected!</div>';
                return;
            }

            encodingContent.innerHTML = `
                <div class="alert alert-info">üè∑Ô∏è ${categoricalColumns.length} categorical columns need encoding</div>
                <div class="column-list">
                    ${categoricalColumns.map(([colName, info]) => `
                        <div class="column-item">
                            <div class="column-info">
                                <div class="column-name">${colName}</div>
                                <div class="column-details">
                                    Unique values: ${info.unique_values} | 
                                    Sample: ${info.sample_values.slice(0, 3).join(', ')}...
                                </div>
                            </div>
                            <div class="column-actions">
                                <select class="select-field" onchange="updateEncodingStrategy('${colName}', this.value)">
                                    <option value="">Choose encoding...</option>
                                    <option value="label">Label Encoding</option>
                                    <option value="onehot">One-Hot Encoding</option>
                                    <option value="ordinal">Ordinal Encoding</option>
                                </select>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Cleaning operation handlers
        function updateRename(columnName, newName) {
            if (!cleaningOperations.rename_columns) cleaningOperations.rename_columns = {};
            if (newName.trim()) {
                cleaningOperations.rename_columns[columnName] = newName.trim();
            } else {
                delete cleaningOperations.rename_columns[columnName];
            }
        }

        function markForDrop(columnName) {
            if (!cleaningOperations.drop_columns) cleaningOperations.drop_columns = [];
            if (!cleaningOperations.drop_columns.includes(columnName)) {
                cleaningOperations.drop_columns.push(columnName);
                showAlert(`Marked "${columnName}" for deletion`, 'info');
            }
        }

        function updateMissingStrategy(columnName, strategy) {
            if (!cleaningOperations.missing_values) cleaningOperations.missing_values = {};
            
            cleaningOperations.missing_values[columnName] = { method: strategy };
            
            // Show/hide custom value input
            const customInput = document.getElementById(`custom-${columnName}`);
            if (strategy === 'custom_value' && customInput) {
                customInput.style.display = 'block';
                customInput.onchange = (e) => {
                    cleaningOperations.missing_values[columnName].value = e.target.value;
                };
            } else if (customInput) {
                customInput.style.display = 'none';
            }
        }

        function updateEncodingStrategy(columnName, strategy) {
            if (!cleaningOperations.categorical_encoding) cleaningOperations.categorical_encoding = {};
            cleaningOperations.categorical_encoding[columnName] = { method: strategy };
        }

        async function applyCleaningOperations() {
            if (!currentDataset || Object.keys(cleaningOperations).length === 0) {
                showAlert('No cleaning operations to apply', 'warning');
                return;
            }

            try {
                showLoading('Applying data cleaning operations...');
                
                const response = await fetch('/api/apply_cleaning', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentDataset,
                        operations: cleaningOperations
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Data cleaned successfully! New file: ${result.cleaned_filename}`, 'success');
                    addDatasetToSelect(result.cleaned_filename);
                    document.getElementById('dataset-select').value = result.cleaned_filename;
                    currentDataset = result.cleaned_filename;
                    addActivityLog(`Data cleaning completed`, 100);
                    
                    // Display cleaning summary
                    displayCleaningSummary(result);
                } else {
                    showAlert('Cleaning failed: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Cleaning error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function displayCleaningSummary(result) {
            const summaryHtml = `
                <div class="alert alert-success">
                    <h4>üéâ Cleaning Summary</h4>
                    <p><strong>Original shape:</strong> ${result.original_shape[0]} √ó ${result.original_shape[1]}</p>
                    <p><strong>Final shape:</strong> ${result.final_shape[0]} √ó ${result.final_shape[1]}</p>
                    <p><strong>Quality Score:</strong> ${result.quality_report.quality_score.toFixed(1)}/100</p>
                    ${result.validation.is_valid ? 
                        '<p>‚úÖ Dataset is ready for training!</p>' : 
                        '<p>‚ö†Ô∏è Dataset may need additional cleaning</p>'
                    }
                </div>
            `;
            
            document.getElementById('overview-tab').innerHTML = summaryHtml + document.getElementById('overview-tab').innerHTML;
        }

        // Training functions
        async function startTraining() {
            if (!currentDataset || !sessionId) {
                showAlert('Please select a dataset and ensure connection is established', 'warning');
                return;
            }

            // Get training configuration
            const config = {
                test_size: 0.2,
                cross_validation_folds: 5,
                hyperparameter_tuning: true,
                feature_engineering: true
            };

            addActivityLog('Starting model training...', 0);
            document.getElementById('results-section').style.display = 'none';
            
            // Emit training start event
            socket.emit('start_training', {
                session_id: sessionId,
                dataset: currentDataset,
                config: config
            });
        }

        function displayTrainingResults(data) {
            const resultsSection = document.getElementById('results-section');
            const modelSummary = data.model_summary;
            
            // Update metrics
            updateMetricsGrid(modelSummary);
            
            // Update models table
            updateModelsTable(modelSummary.model_results, modelSummary.best_model);
            
            // Update visualizations
            updateVisualizationGrid(data.plots);
            
            resultsSection.style.display = 'block';
            addActivityLog('Training results displayed', 100);
        }

        function updateMetricsGrid(summary) {
            const metricsGrid = document.getElementById('metrics-grid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${summary.best_model}</div>
                    <div class="metric-label">Best Model</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${summary.best_score.toFixed(4)}</div>
                    <div class="metric-label">Best R¬≤ Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${summary.total_models}</div>
                    <div class="metric-label">Models Trained</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${summary.data_info.processed_shape[0]}</div>
                    <div class="metric-label">Training Samples</div>
                </div>
            `;
        }

        function updateModelsTable(modelResults, bestModel) {
            const tbody = document.getElementById('models-tbody');
            tbody.innerHTML = Object.entries(modelResults).map(([modelName, results]) => `
                <tr class="${modelName === bestModel ? 'best-model-row' : ''}">
                    <td><strong>${modelName}</strong></td>
                    <td>${results.r2.toFixed(4)}</td>
                    <td>${results.mse.toFixed(4)}</td>
                    <td>${results.mae.toFixed(4)}</td>
                    <td>${results.rmse.toFixed(4)}</td>
                    <td>${results.cv_mean.toFixed(3)} ¬± ${results.cv_std.toFixed(3)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="showModelDetails('${modelName}')">
                            üìä Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateVisualizationGrid(plots) {
            const vizGrid = document.getElementById('visualization-grid');
            const plotTitles = {
                'comparison': 'üìä Model Performance Comparison',
                'best_scatter': 'üéØ Best Model: Predicted vs Actual',
                'heatmap': 'üî• Performance Metrics Heatmap',
                'residuals': 'üìà Residual Analysis',
                'feature_importance': 'üîë Feature Importance'
            };

            vizGrid.innerHTML = Object.entries(plots).map(([plotType, plotPath]) => `
                <div class="viz-card">
                    <div class="viz-title">${plotTitles[plotType] || 'Analysis Plot'}</div>
                    <img src="/${plotPath}" alt="${plotTitles[plotType]}" 
                         onerror="this.style.display='none'" loading="lazy">
                </div>
            `).join('');
        }

        // Utility functions
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}-tab`);
            });
        }

        function updateProgress(progress, message) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${progress}%`;
            
            if (progress === 100) {
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 2000);
            }
        }

        function addActivityLog(message, progress) {
            const activityStream = document.getElementById('activity-stream');
            const timestamp = new Date().toLocaleTimeString();
            
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
                <span class="activity-timestamp">${timestamp}</span>
                <span class="activity-message">${message}</span>
                <span class="activity-progress">${progress}%</span>
            `;
            
            activityStream.insertBefore(activityItem, activityStream.firstChild);
            
            // Keep only last 20 items
            while (activityStream.children.length > 20) {
                activityStream.removeChild(activityStream.lastChild);
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <span>${message}</span>
                <button style="margin-left: auto; background: none; border: none; font-size: 1.2rem; cursor: pointer;" 
                        onclick="this.parentElement.remove()">√ó</button>
            `;
            alertDiv.style.display = 'flex';
            alertDiv.style.alignItems = 'center';
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.dashboard-grid'));
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showLoading(message = 'Processing...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showModelDetails(modelName) {
            // This would show detailed model information in a modal
            showAlert(`Detailed view for ${modelName} - Feature coming soon!`, 'info');
        }

        // Initialize WebSocket connection
        socket.connect();
    </script>
</body>
</html>